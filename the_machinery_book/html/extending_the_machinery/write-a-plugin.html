<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Writing a plugin - The Machinery Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item expanded "><a href="../what_is_the_machinery.html"><strong aria-hidden="true">2.</strong> What is The Machinery</a></li><li class="chapter-item expanded "><a href="../licenses.html"><strong aria-hidden="true">3.</strong> Licenses</a></li><li class="chapter-item expanded "><a href="../getting_started/index.html"><strong aria-hidden="true">4.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/what_is_in_the_package.html"><strong aria-hidden="true">4.1.</strong> What is in this package</a></li><li class="chapter-item expanded "><a href="../getting_started/logging_in.html"><strong aria-hidden="true">4.2.</strong> Sign In</a></li><li class="chapter-item expanded "><a href="../getting_started/new_project.html"><strong aria-hidden="true">4.3.</strong> New Project</a></li><li class="chapter-item expanded "><a href="../getting_started/first_gameplay_project.html"><strong aria-hidden="true">4.4.</strong> First Gameplay Project</a></li><li class="chapter-item expanded "><a href="../getting_started/sample-projects.html"><strong aria-hidden="true">4.5.</strong> Sample Projects</a></li><li class="chapter-item expanded "><a href="../getting_started/troubleshooting.html"><strong aria-hidden="true">4.6.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="../getting_started/migration_from_unity.html"><strong aria-hidden="true">4.7.</strong> The Machinery for Unity Dev's</a></li><li class="chapter-item expanded "><a href="../getting_started/migration_from_unreal.html"><strong aria-hidden="true">4.8.</strong> The Machinery for Unreal 4 Dev's</a></li></ol></li><li class="chapter-item expanded "><a href="../the_editor/index.html"><strong aria-hidden="true">5.</strong> The Editor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../the_editor/tabs.html"><strong aria-hidden="true">5.1.</strong> About Tabs</a></li><li class="chapter-item expanded "><a href="../the_editor/entity_tree_tab.html"><strong aria-hidden="true">5.2.</strong> Entity Tree Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/scene_tab.html"><strong aria-hidden="true">5.3.</strong> Scene Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/properties_tab.html"><strong aria-hidden="true">5.4.</strong> Properties Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/asset_browser.html"><strong aria-hidden="true">5.5.</strong> Asset Browser</a></li><li class="chapter-item expanded "><a href="../the_editor/simulate_tab.html"><strong aria-hidden="true">5.6.</strong> Simulate Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/preview_tab.html"><strong aria-hidden="true">5.7.</strong> Preview Tab</a></li></ol></li><li class="chapter-item expanded "><a href="../editing_workflows/index.html"><strong aria-hidden="true">6.</strong> Editing Workflows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../editing_workflows/entities.html"><strong aria-hidden="true">6.1.</strong> Entities</a></li><li class="chapter-item expanded "><a href="../editing_workflows/creation_graphs_asset_pipeline.html"><strong aria-hidden="true">6.2.</strong> Creation graphs and asset pipeline</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../editing_workflows/import_assets.html"><strong aria-hidden="true">6.2.1.</strong> Import Assets</a></li><li class="chapter-item expanded "><a href="../editing_workflows/import_projects.html"><strong aria-hidden="true">6.2.2.</strong> Import Projects</a></li></ol></li><li class="chapter-item expanded "><a href="../editing_workflows/prototypes.html"><strong aria-hidden="true">6.3.</strong> Prototypes</a></li><li class="chapter-item expanded "><a href="../editing_workflows/simulation.html"><strong aria-hidden="true">6.4.</strong> Simulation</a></li><li class="chapter-item expanded "><a href="../editing_workflows/visual-scripting.html"><strong aria-hidden="true">6.5.</strong> Visual Scripting: Entity Graphs</a></li><li class="chapter-item expanded "><a href="../editing_workflows/physics.html"><strong aria-hidden="true">6.6.</strong> Physics</a></li><li class="chapter-item expanded "><a href="../editing_workflows/animation/index.html"><strong aria-hidden="true">6.7.</strong> Animation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../editing_workflows/animation/animation-state-machine.html"><strong aria-hidden="true">6.7.1.</strong> Animation state machines</a></li></ol></li><li class="chapter-item expanded "><a href="../editing_workflows/sound.html"><strong aria-hidden="true">6.8.</strong> Sound</a></li><li class="chapter-item expanded "><a href="../editing_workflows/publish.html"><strong aria-hidden="true">6.9.</strong> Publish</a></li><li class="chapter-item expanded "><a href="../editing_workflows/sculpting.html"><strong aria-hidden="true">6.10.</strong> Sculpt Tool / White boxing</a></li></ol></li><li class="chapter-item expanded "><a href="../collaboration.html"><strong aria-hidden="true">7.</strong> Collaboration</a></li><li class="chapter-item expanded "><a href="../the_truth/index.html"><strong aria-hidden="true">8.</strong> The Truth</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../the_truth/access_values.html"><strong aria-hidden="true">8.1.</strong> Access values</a></li><li class="chapter-item expanded "><a href="../the_truth/create_an_object.html"><strong aria-hidden="true">8.2.</strong> Create an object</a></li><li class="chapter-item expanded "><a href="../the_truth/modify_an_object.html"><strong aria-hidden="true">8.3.</strong> Modify an object</a></li><li class="chapter-item expanded "><a href="../the_truth/common_types.html"><strong aria-hidden="true">8.4.</strong> Common Types</a></li></ol></li><li class="chapter-item expanded "><a href="../extending_the_machinery/index.html"><strong aria-hidden="true">9.</strong> Extending The Machinery</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extending_the_machinery/the_plugin_system.html"><strong aria-hidden="true">9.1.</strong> The Plugin System</a></li><li class="chapter-item expanded "><a href="../extending_the_machinery/hot-reloading.html"><strong aria-hidden="true">9.2.</strong> Hot-reloading</a></li><li class="chapter-item expanded "><a href="../extending_the_machinery/plugin-assets.html"><strong aria-hidden="true">9.3.</strong> Plugin assets</a></li><li class="chapter-item expanded "><a href="../extending_the_machinery/write-a-plugin.html" class="active"><strong aria-hidden="true">9.4.</strong> Writing a plugin</a></li><li class="chapter-item expanded "><a href="../the_truth/custom_truth_type.html"><strong aria-hidden="true">9.5.</strong> Create a custom Truth Type</a></li></ol></li><li class="chapter-item expanded "><a href="../gameplay_coding/index.html"><strong aria-hidden="true">10.</strong> Gameplay coding</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gameplay_coding/simulate_entry.html"><strong aria-hidden="true">10.1.</strong> Simulate Entry in C</a></li><li class="chapter-item expanded "><a href="../gameplay_coding/extend_the_visual_scripting_language.html"><strong aria-hidden="true">10.2.</strong> Extending the visual scripting language</a></li><li class="chapter-item expanded "><a href="../gameplay_coding/ecs/index.html"><strong aria-hidden="true">10.3.</strong> Entity Component System</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gameplay_coding/ecs/write_a_custom_component.html"><strong aria-hidden="true">10.3.1.</strong> Write a custom component</a></li><li class="chapter-item expanded "><a href="../gameplay_coding/ecs/write_a_system_or_engine.html"><strong aria-hidden="true">10.3.2.</strong> Write a Systems &amp; Engines</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../qa_pipeline/index.html"><strong aria-hidden="true">11.</strong> QA Pipeline</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../qa_pipeline/how_to_write_unit_tests.html"><strong aria-hidden="true">11.1.</strong> Write your own unit tests</a></li><li class="chapter-item expanded "><a href="../qa_pipeline/how_to_write_integration_tests.html"><strong aria-hidden="true">11.2.</strong> Write your own integration tests</a></li></ol></li><li class="chapter-item expanded "><a href="../helper_tools/index.html"><strong aria-hidden="true">12.</strong> Helper Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../helper_tools/tmbuild.html"><strong aria-hidden="true">12.1.</strong> How to use tmbuild</a></li><li class="chapter-item expanded "><a href="../helper_tools/hash.html"><strong aria-hidden="true">12.2.</strong> How to use hash</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_an_executable.html"><strong aria-hidden="true">13.</strong> Writing an executable</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Machinery Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/OurMachinery/themachinery-books" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="writing-a-plugin"><a class="header" href="#writing-a-plugin">Writing a plugin</a></h2>
<p>This walkthrough show you how to extend the engine with a custom plugin.</p>
<p>You will learn about:</p>
<ul>
<li>What is needed to write a plugin</li>
<li>How to write a plugin</li>
</ul>
<p>This walk through expects you to have the basic understanding about the plugin system. Otherwise you can read more <a href="https://ourmachinery.github.io/themachinery-books//the_machinery_book/extending_the_machinery/the_plugin_system.html">here</a>.</p>
<p>The Machinery is built around a plugin model. All features, even the built-in ones, are provided
through plugins. You can extend The Machinery by writing your own plugins. When The Machinery
launches, it loads all the plugins named <code>tm_*.dll</code> in its <code>plugins/</code> folder. If you write your own
plugins, name them so that they start with <code>tm_</code> and put them in this folder, they will be loaded
together with the built-in plugins.</p>
<p>The easiest way to build a plugin is to start with an existing example. There are three places where
you can find plugin samples:</p>
<ol>
<li>
<p>The <code>samples</code> folder in the SDK has a number of plugin samples.</p>
</li>
<li>
<p>The <em>All Sample Projects</em> package in the <em>Download</em> tab has a <code>plugins</code> folder with some small
samples.</p>
</li>
<li>
<p>You can create a new plugin with the menu command <strong>File &gt; New Plugin</strong>. This will create a
new <code>.c</code> file for the plugin together with some helper files for compiling it.</p>
</li>
</ol>
<p>The distribution already comes with pre-built .dlls for the sample plugins, such as
<code>bin/plugins/tm_pong_tab.dll</code>. You can see this plugin in action by selecting <strong>Tab &gt; Pong</strong> in the
editor to open up its tab:</p>
<p><img src="https://www.dropbox.com/s/hats2jgr3wroahz/pong-tab.png?dl=1" alt="Pong tab." /></p>
<p>To build the sample plugins (and your own) you need three things:</p>
<ol>
<li>
<p>You need to have Visual Studio 2019 installed including the MS C++ Build Tools on your computer.
Note that the Community Edition works fine.</p>
</li>
<li>
<p>You need to set the <code>TM_SDK_DIR</code> environment variable to the path of the SDK package that you
installed on your computer. When you compile a plugin, it looks for The Machinery headers in the
<code>%TM_SDK_DIR%/headers</code> folder.</p>
</li>
<li>
<p>You need the <code>tmbuild.exe</code> from the SDK package. <code>tmbuild.exe</code> does all the steps needed to
compile the plugin. Put it in your <code>PATH</code> or copy it to your plugin folder so that you can run it
easily from the command line.</p>
</li>
</ol>
<p>To compile a plugin, simply open a command prompt in the plugin folder and run the <code>tmbuild.exe</code>
executable:</p>
<pre><code class="language-cmdinput">sample-projects/plugins/custom_tab&gt; %TM_SDK_DIR%/bin/tmbuild.exe
​~~~ cmd output
Installing 7za.exe...
Installing premake-5.0.0-alpha14-windows...
Building configurations...
Running action 'vs2019'...
Generated custom_tab.sln...
Generated build/custom_tab/custom_tab.vcxproj...
Done (133ms).
Microsoft (R) Build Engine version 16.4.0+e901037fe for .NET Framework
Copyright (C) Microsoft Corporation. All rights reserved.

  custom_tab.c
  custom_tab.vcxproj -&gt; C:\work\themachinery\build\bin\plugins\tm_custom_tab.dll

-----------------------------
tmbuild completed in: 23.471 s
</code></pre>
<p><code>tmbuild.exe</code> will perform the following steps to build your executable:</p>
<ol>
<li>
<p>Create a <code>libs</code> folder and download <code>premake5</code> into it. (You can set the <code>TM_LIB_DIR</code> environment
variable to use a shared <code>libs</code> dir for all your projects.)</p>
</li>
<li>
<p>Run <code>premake5</code> to create a Visual Studio project from the <code>premake5.lua</code> script.</p>
</li>
<li>
<p>Build the Visual Studio project to build the plugin.</p>
</li>
</ol>
<p>In order to write a plugin, it is useful to understand a little bit about how the plugin system in <em>The
Machinery</em> works.</p>
<p><em>The Machinery</em> uses C99 as its interface language. I.e., all the header files that you use to
communicate with <em>The Machinery</em> are C99 header files, and when you write a plugin you should expose
C99 headers for your APIs. The <em>implementation</em> of a plugin can be written in whichever language you
like, as long as it exposes and communicates through a C99 header. In particular, you can write the
implementation in C++ if you want to. (At Our Machinery, we write the implementations in C99.)</p>
<p><em>The Machinery</em> is organized into individual APIs that can be called to perform specific tasks. A
plugin is a DLL that exposes one or several of these APIs. In order to implement its functionality,
the plugin may in turn rely on APIs exposed by other plugins.</p>
<p>A central object called the <em>API registry</em> is used to keep track of all the APIs. When you want to
use an API from another plugin, you ask the API registry for it. Similarly, you expose your APIs to
the world by registering them with the API registry.</p>
<p>This may seem a bit abstract at this point, so let’s look at a concrete example, <code>unicode.h</code> which
exposes an API for encoding and decoding Unicode strings:</p>
<pre><code class="language-c">// This header has been abridged and commented from the original to make things
// clearer.

// Include standard header.
#include &quot;api_types.h&quot;

// Forward declarations.
struct tm_temp_allocator_i;

// Name of this API in the registry.
#define TM_UNICODE_API_NAME &quot;tm_unicode_api&quot;

// Unicode helper functions.
struct tm_unicode_api
{
    // Encodes the `codepoint` as UTF-8 into `utf8` and returns a pointer to the
    // position where to insert the next codepoint. `utf8` should have room for at
    // least four bytes (the maximum size of a UTF-8 encoded codepoint).
    char *(*utf8_encode)(char *utf8, uint32_t codepoint);

    // Decodes and returns the first codepoint in the UTF-8 string `utf8`. The string
    // pointer is advanced to point to the next codepoint in the string. Will generate
    // an error message if the string is not a UTF-8 string.
    uint32_t (*utf8_decode)(const char **utf8);

    // ...
};
</code></pre>
<p>Let’s go through this.</p>
<p>First, the code includes <code>&lt;api_types.h&gt;</code>. This is a shared header with common type declarations, it
includes things like <code>&lt;stdbool.h&gt;</code> and <code>&lt;stdint.h&gt;</code> and also defines a few <em>The Machinery</em> specific
types, such as <code>tm_vec3_t</code>.</p>
<p>In <em>The Machinery</em> we have a rule that header files can't include other header files (except
for <code>&lt;api_types.h&gt;</code>). This helps keep compile times down, but it also simplifies the structure of the
code. When you read a header file you don’t have to follow a long chain of other header files to understand
what is happening.</p>
<p>Next follows a block of forward struct declarations (in this case only one).</p>
<p>Next, we have the name of this API defined as a constant <code>TM_UNICODE_API_NAME</code>, followed by the
<code>struct tm_unicode_api</code> that defines the functions in the API.</p>
<p>To use this API, you would first use the API registry to query for the API pointer, then using that
pointer, call the functions of the API:</p>
<pre><code class="language-c">struct tm_unicode_api *tm_unicode_api =
    (struct tm_unicode_api *)tm_global_api_registry-&gt;get(TM_UNICODE_API_NAME);

tm_unicode_api-&gt;utf8_encode(utf8, codepoint);
</code></pre>
<p>The different APIs that you can query for and use are documented in their respective header files,
and in the <code>apidoc.md.html</code> documentation file (which is just extracted from the headers). Consult
these files for information on how to use the various APIs that are available in <em>The Machinery.</em></p>
<p>In addition to APIs defined in header files, <em>The Machinery</em> also contains some header files with
inline functions that you can include directly into your implementation files. For example
<code>&lt;math.inl&gt;</code> provides common mathematical operations on vectors and matrices, while <code>&lt;carray.inl&gt;</code>
provides a “stretchy-buffer” implementation (i.e. a C version of C++’s <code>std::vector</code>).</p>
<p>To write a plugin you need to implement a <code>tm_load_plugin()</code> function that is called whenever the
plugin DLL is loaded/unloaded. In this function, you can interact with various engine interfaces. For
example, you can implement <code>TM_UNIT_TEST_INTERFACE_NAME</code> to implement unit tests that get run
together with the engine unit tests, you can implement <code>TM_THE_TRUTH_CREATE_TYPES_INTERFACE_NAME</code> to
extend our data model, The Truth, with your own data types or implement
<code>TM_ENTITY_CREATE_COMPONENT_INTERFACE_NAME</code> to extend our entity model with your own component
types.</p>
<p>You can also create your own APIs that other plugins can query for. If you create your own APIs, you
want to define them in your header file, so that other plugins can <code>#include</code> it and know how to
call your APIs. Note that if you are not defining your own APIs, but just implementing some of the
engine's ones, your plugin typically doesn't need a header file:</p>
<p><strong>my_plugin.h:</strong></p>
<pre><code class="language-c">#include &quot;foundation/api_types.h&quot;

#define MY_API_NAME &quot;my_api&quot;

struct my_api
{
    void (*foo)(void);
};
</code></pre>
<p><strong>my_plugin.c:</strong></p>
<pre><code class="language-c">static struct tm_api_registry_api *tm_global_api_registry;
static struct tm_error_api *tm_error_api;
static struct tm_logger_api *tm_logger_api;

#include &quot;my_plugin.h&quot;

#include &quot;foundation/api_registry.h&quot;
#include &quot;foundation/error.h&quot;
#include &quot;foundation/log.h&quot;
#include &quot;foundation/unit_test.h&quot;

static void foo(void)
{
    // ...
}

static struct my_api *my_api = &amp;(struct my_api) {
    .foo = foo,
};

static void my_unit_test(tm_unit_test_runner_i *tr, struct tm_allocator_i *a)
{
    // ...
}

static struct tm_unit_test_i *my_unit_test = &amp;(struct tm_unit_test_i) {
    .name = &quot;my_api&quot;,
    .test = my_unit_test,
};

TM_DLL_EXPORT void tm_load_plugin(struct tm_api_registry_api *reg, bool load)
{
    tm_global_api_registry = reg;

    tm_error_api = reg-&gt;get(TM_ERROR_API_NAME);
    tm_logger_api = reg-&gt;get(TM_LOGGER_API_NAME);

    tm_set_or_remove_api(reg, load, MY_API_NAME, my_api);

    tm_add_or_remove_implementation(reg, load, TM_UNIT_TEST_INTERFACE_NAME, my_unit_test);
}
</code></pre>
<p>When The Machinery loads a plugin DLL, it looks for the <code>tm_load_plugin()</code> function and calls it.
If it can't find the function, it prints an error message.</p>
<p>We store the API registry pointer in a static variable so that we can use it everywhere in our DLL.
We also <code>get()</code> some of the API pointers that we will use frequently and store them in static
variables so that we don’t have to use the registry to query for them every time we want to use
them. Finally, we add our own API to the registry, so others can query for and use it.</p>
<p>We also add an <em>implementation</em> of the unit test <em>interface</em> to the registry. The API registry has
support for both APIs and interfaces. The difference is that APIs only have a single implementation,
whereas interfaces can have many implementations. For example, all code that can be unit-tested
implements the unit test interface. Unit test programs can query the API registry to find all these
implementations and run all the unit tests.</p>
<p>To extend the editor you add implementations to the interfaces used by the editor. For example, you
can add implementations of the <code>TM_THE_TRUTH_CREATE_TYPES_INTERFACE_NAME</code>  in order to create new
data types in The Truth, and add implementations of the <code>TM_ENTITY_CREATE_COMPONENT_INTERFACE_NAME</code>
in order to define new entity components. See the sample plugin examples.</p>
<p>It does not matter in which order the plugins are loaded. If you query for a plugin that hasn’t yet
been registered, you get a pointer to a nulled struct back. When the plugin is loaded, that struct
is filled in with the actual function pointers. As long as you don’t <em>call</em> the functions before the
plugin that implements them has been loaded, you are good. (You can test this by checking for NULL
pointers in the struct.)</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../extending_the_machinery/plugin-assets.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../the_truth/custom_truth_type.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../extending_the_machinery/plugin-assets.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../the_truth/custom_truth_type.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
